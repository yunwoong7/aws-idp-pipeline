AWSTemplateFormatVersion: '2010-09-09'
Description: CodeBuild project for deploying AWS IDP AI Pipeline

Parameters:
  AdminUserEmail:
    Type: String
    Description: Admin user email for Cognito authentication
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: Must be a valid email address
  
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Deployment stage
  
  EnableCognito:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable Cognito authentication
  
  UseCustomDomain:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Use custom domain for ALB
  
  DomainName:
    Type: String
    Default: ''
    Description: Custom domain name (required if UseCustomDomain is true)
  
  HostedZoneName:
    Type: String
    Default: ''
    Description: Route53 hosted zone name (required if UseCustomDomain is true)

  HostedZoneId:
    Type: String
    Default: ''
    Description: Route53 hosted zone ID (auto-discovered from HostedZoneName)

  UseRoute53:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Use Route 53 for DNS management (required if UseCustomDomain is true)

  CustomDomainFull:
    Type: String
    Default: ''
    Description: Full custom domain name (e.g., idp.demo.com) when not using Route 53

  ExistingCertArn:
    Type: String
    Default: ''
    Description: Existing ACM certificate ARN (required if UseCustomDomain is true and UseRoute53 is false)

  RepoUrl:
    Type: String
    Default: 'https://github.com/yunwoong7/aws-idp-pipeline.git'
    Description: Repository URL
  
  Version:
    Type: String
    Default: 'main'
    Description: Branch or tag to deploy

Resources:
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/PowerUserAccess
      Policies:
        - PolicyName: CodeBuildServiceRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:PassRole
                  - iam:TagRole
                  - iam:UntagRole
                  - iam:ListRolePolicies
                  - iam:ListAttachedRolePolicies
                  - iam:CreatePolicy
                  - iam:DeletePolicy
                  - iam:GetPolicy
                  - iam:GetPolicyVersion
                  - iam:ListPolicyVersions
                  - iam:CreateServiceLinkedRole
                Resource: '*'
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                Resource: 
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:role/cdk-*'

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub 'aws-idp-ai-deploy-${Stage}'
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_LARGE
        Image: aws/codebuild/standard:7.0
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: ADMIN_USER_EMAIL
            Value: !Ref AdminUserEmail
          - Name: STAGE
            Value: !Ref Stage
          - Name: ENABLE_COGNITO
            Value: !Ref EnableCognito
          - Name: USE_CUSTOM_DOMAIN
            Value: !Ref UseCustomDomain
          - Name: DOMAIN_NAME
            Value: !Ref DomainName
          - Name: HOSTED_ZONE_NAME
            Value: !Ref HostedZoneName
          - Name: HOSTED_ZONE_ID
            Value: !Ref HostedZoneId
          - Name: USE_ROUTE53
            Value: !Ref UseRoute53
          - Name: CUSTOM_DOMAIN_FULL
            Value: !Ref CustomDomainFull
          - Name: EXISTING_CERT_ARN
            Value: !Ref ExistingCertArn
          - Name: REPO_URL
            Value: !Ref RepoUrl
          - Name: VERSION
            Value: !Ref Version
          - Name: AWS_DEFAULT_REGION
            Value: !Ref AWS::Region
          - Name: AWS_ACCOUNT_ID
            Value: !Ref AWS::AccountId
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2
          phases:
            pre_build:
              commands:
                - npm install -g aws-cdk@latest pnpm
                - git clone $REPO_URL /tmp/aws-idp-pipeline
                - cd /tmp/aws-idp-pipeline
                - git checkout $VERSION
            build:
              commands:
                - cd /tmp/aws-idp-pipeline
                - pnpm install
                - cd packages/infra
                - |
                  cat > .toml << EOF
                  [app]
                  ns = "aws-idp-ai"
                  stage = "$STAGE"
                  
                  [dynamodb]
                  documentsTableName = "aws-idp-ai-documents"
                  pagesTableName = "aws-idp-ai-pages"
                  
                  [s3]
                  documentsBucketName = "aws-idp-ai-documents"
                  
                  [opensearch]
                  domainName = "aws-idp-ai-opensearch"
                  indexName = "aws-idp-ai-analysis"
                  instanceType = "t3.small.search"
                  instanceCount = 1
                  dedicatedMasterEnabled = false
                  
                  [apigateway]
                  throttleRateLimit = 1000
                  throttleBurstLimit = 2000
                  
                  [bedrock]
                  analysisAgentModelId = "us.anthropic.claude-3-7-sonnet-20250219-v1:0"
                  analysisAgentMaxToken = 8192
                  analysisImageModelId = "us.anthropic.claude-3-7-sonnet-20250219-v1:0"
                  analysisImageMaxToken = 8192
                  analysisVideoModelId = "us.twelvelabs.pegasus-1-2-v1:0"
                  analysisSummarizerModelId = "us.anthropic.claude-3-7-sonnet-20250219-v1:0"
                  analysisSummarizerMaxToken = 64000
                  embeddingsModelId = "amazon.titan-embed-text-v2:0"
                  embeddingsDimensions = 1024
                  rerankModelId = "cohere.rerank-v3-5:0"
                  vectorWeight = 0.6
                  keywordWeight = 0.4
                  searchThresholdScore = 0.4
                  
                  [search]
                  hybridSearchSize = 25
                  rerankTopN = 10
                  maxSearchSize = 100
                  rerankScoreThreshold = 0.07
                  
                  [analysis]
                  previousAnalysisMaxCharacters = 1000000000
                  maxIterations = 5
                  
                  [lambda]
                  timeout = 30
                  memorySize = 512
                  runtime = "python3.13"
                  
                  [stepfunctions]
                  documentProcessingTimeout = 6000
                  maxConcurrency = 30
                  
                  [sqs]
                  sqsBatchSize = 1
                  reservedConcurrency = 1
                  EOF
                - pnpm install
                - |
                  LAYER_DIR="./src/lambda_layer"
                  GITHUB_REPO="https://raw.githubusercontent.com/yunwoong7/lambda-layers-assets/main/aws-idp-assets"
                  LAYERS="custom_layer_common.zip custom_layer_opensearch.zip custom_layer_image_processing.zip custom_layer_analysis_package.zip"
                  for layer in $LAYERS; do
                    [ ! -f "$LAYER_DIR/$layer" ] && curl -Lf -o "$LAYER_DIR/$layer" "$GITHUB_REPO/$layer" || true
                  done

                - |
                  STACK_STATUS=$(aws cloudformation describe-stacks --stack-name CDKToolkit --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "STACK_NOT_FOUND")
                  if [ "$STACK_STATUS" = "STACK_NOT_FOUND" ] || [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ]; then
                    aws cloudformation delete-stack --stack-name CDKToolkit 2>/dev/null || true
                    aws cloudformation wait stack-delete-complete --stack-name CDKToolkit 2>/dev/null || true
                    BUCKET_NAME="cdk-hnb659fds-assets-${AWS_ACCOUNT_ID}-${AWS_DEFAULT_REGION}"
                    aws s3 rm s3://$BUCKET_NAME --recursive 2>/dev/null || true
                    aws s3api delete-bucket --bucket $BUCKET_NAME 2>/dev/null || true
                    npx cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION --require-approval never
                  fi
                - npx cdk deploy aws-idp-ai-ecr --require-approval never
                - npx cdk deploy aws-idp-ai-lambda-layer --require-approval never
                - aws logs delete-log-group --log-group-name "/aws-idp-ai/vpc/flowlogs" 2>/dev/null || true
                - npx cdk deploy aws-idp-ai-vpc --require-approval never
                - npx cdk deploy aws-idp-ai-dynamodb --require-approval never
                - npx cdk deploy aws-idp-ai-s3 --require-approval never
                - |
                  aws iam get-role --role-name AWSServiceRoleForAmazonOpenSearchService >/dev/null 2>&1 || aws iam create-service-linked-role --aws-service-name opensearch.amazonaws.com >/dev/null 2>&1 && sleep 10
                - |
                  for i in 1 2 3; do
                    npx cdk deploy aws-idp-ai-opensearch --require-approval never && break || sleep 30
                  done
                - |
                  OPENSEARCH_DOMAIN_NAME=$(aws opensearch list-domain-names --query "DomainNames[0].DomainName" --output text 2>/dev/null | head -1)
                  [ -n "$OPENSEARCH_DOMAIN_NAME" ] && [ "$OPENSEARCH_DOMAIN_NAME" != "None" ] && aws opensearch associate-package --domain-name "$OPENSEARCH_DOMAIN_NAME" --package-id G256321959 2>/dev/null || true
                
                - |
                  if [ "$ENABLE_COGNITO" = "true" ] && [ "$USE_CUSTOM_DOMAIN" != "true" ]; then
                    EXISTING_CERTS=$(aws acm list-certificates --query 'CertificateSummaryList[?DomainName==`aws-idp-ai.internal`].CertificateArn' --output text 2>/dev/null || true)
                    CERT_COUNT=$(echo "$EXISTING_CERTS" | wc -w)
                    if [ "$CERT_COUNT" -gt 1 ]; then
                      CERT_ARN=$(echo "$EXISTING_CERTS" | awk '{print $1}')
                      for EXTRA_CERT in $(echo "$EXISTING_CERTS" | awk '{for(i=2;i<=NF;i++) print $i}'); do
                        aws acm delete-certificate --certificate-arn "$EXTRA_CERT" 2>/dev/null || true
                      done
                    elif [ -n "$EXISTING_CERTS" ]; then
                      CERT_ARN="$EXISTING_CERTS"
                    else
                      rm -rf certs/ 2>/dev/null || true
                      mkdir -p certs
                      openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout "certs/private.key" -out "certs/certificate.pem" -subj "/CN=aws-idp-ai.internal" -addext "subjectAltName=DNS:aws-idp-ai.internal"
                      openssl x509 -in "certs/certificate.pem" -out "certs/certificate.pem" -outform PEM >/dev/null 2>&1
                      CERT_ARN=$(aws acm import-certificate --certificate fileb://certs/certificate.pem --private-key fileb://certs/private.key --output text --query 'CertificateArn')
                    fi
                    npx cdk deploy aws-idp-ai-cognito --require-approval never --context adminUserEmail="$ADMIN_USER_EMAIL" --context useCustomDomain="false" --context existingCertificateArn="$CERT_ARN"
                  else
                    CERT_ARN=""
                  fi

                - |
                  if [ "$USE_CUSTOM_DOMAIN" = "true" ] && [ "$ENABLE_COGNITO" = "true" ]; then
                    if [ "$USE_ROUTE53" = "true" ]; then
                      npx cdk deploy aws-idp-ai-certificate --require-approval never --context adminUserEmail="$ADMIN_USER_EMAIL" --context useCustomDomain="true" --context domainName="$DOMAIN_NAME" --context hostedZoneId="$HOSTED_ZONE_ID" --context hostedZoneName="$HOSTED_ZONE_NAME"
                      CERT_ARN=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-certificate --query 'Stacks[0].Outputs[?OutputKey==`CertificateArn`].OutputValue' --output text)
                    else
                      CERT_ARN="$EXISTING_CERT_ARN"
                      aws acm describe-certificate --certificate-arn "$CERT_ARN" >/dev/null 2>&1 || exit 1
                    fi
                  fi

                - npx cdk deploy aws-idp-ai-workflow --require-approval never
                - npx cdk deploy aws-idp-ai-document-management --require-approval never
                - npx cdk deploy aws-idp-ai-indices-management --require-approval never
                - npx cdk deploy aws-idp-ai-api-gateway --require-approval never
                - aws logs delete-log-group --log-group-name "/aws/lambda/aws-idp-ai-websocket-connect-${STAGE}" 2>/dev/null || true
                - aws logs delete-log-group --log-group-name "/aws/lambda/aws-idp-ai-websocket-disconnect-${STAGE}" 2>/dev/null || true
                - npx cdk deploy aws-idp-ai-websocket-api --require-approval never
                - aws logs delete-log-group --log-group-name "/aws/lambda/aws-idp-ai-documents-stream-handler-${STAGE}" 2>/dev/null || true
                - npx cdk deploy aws-idp-ai-dynamodb-streams --require-approval never
                - |
                  API_GATEWAY_URL=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-api-gateway --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayEndpoint`].OutputValue' --output text)
                  WEBSOCKET_BASE_URL=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-websocket-api --query 'Stacks[0].Outputs[?OutputKey==`WebSocketApiEndpointOutput`].OutputValue' --output text)
                  WEBSOCKET_STAGE=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-websocket-api --query 'Stacks[0].Outputs[?OutputKey==`WebSocketStageNameOutput`].OutputValue' --output text)
                  if [ -n "$WEBSOCKET_BASE_URL" ] && [ -n "$WEBSOCKET_STAGE" ]; then
                    [[ "$WEBSOCKET_BASE_URL" == *"/$WEBSOCKET_STAGE" ]] && WEBSOCKET_URL="$WEBSOCKET_BASE_URL" || WEBSOCKET_URL="${WEBSOCKET_BASE_URL}/${WEBSOCKET_STAGE}"
                  else
                    WEBSOCKET_URL="$WEBSOCKET_BASE_URL"
                  fi
                - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
                - cd /tmp/aws-idp-pipeline
                - docker build --platform linux/amd64 -f packages/backend/Dockerfile -t aws-idp-backend-${STAGE}:latest .
                - docker tag aws-idp-backend-${STAGE}:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/aws-idp-backend-${STAGE}:latest
                - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/aws-idp-backend-${STAGE}:latest
                - |
                  if [ "$USE_CUSTOM_DOMAIN" = "true" ]; then
                    [ "$USE_ROUTE53" = "true" ] && FRONTEND_BACKEND_URL="https://${DOMAIN_NAME}.${HOSTED_ZONE_NAME}" || FRONTEND_BACKEND_URL="https://${CUSTOM_DOMAIN_FULL}"
                    FRONTEND_API_URL="$API_GATEWAY_URL"
                  else
                    FRONTEND_API_URL="$API_GATEWAY_URL"
                    FRONTEND_BACKEND_URL="$API_GATEWAY_URL"
                  fi
                - |
                  docker build --platform linux/amd64 \
                    -f packages/frontend/Dockerfile \
                    --build-arg NEXT_PUBLIC_API_BASE_URL="$FRONTEND_API_URL" \
                    --build-arg NEXT_PUBLIC_ECS_BACKEND_URL="$FRONTEND_BACKEND_URL" \
                    --build-arg NEXT_PUBLIC_WEBSOCKET_URL="$WEBSOCKET_URL" \
                    -t aws-idp-frontend-${STAGE}:latest \
                    .
                - docker tag aws-idp-frontend-${STAGE}:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/aws-idp-frontend-${STAGE}:latest
                - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/aws-idp-frontend-${STAGE}:latest
                - cd packages/infra
                - |
                  if [ "$USE_CUSTOM_DOMAIN" = "true" ]; then
                    if [ "$USE_ROUTE53" = "true" ]; then
                      [ "$ENABLE_COGNITO" = "true" ] && npx cdk deploy aws-idp-ai-ecs --require-approval never --context adminUserEmail="$ADMIN_USER_EMAIL" --context useCustomDomain="true" --context domainName="$DOMAIN_NAME" --context hostedZoneName="$HOSTED_ZONE_NAME" --context hostedZoneId="$HOSTED_ZONE_ID" --context existingCertificateArn="$CERT_ARN" || npx cdk deploy aws-idp-ai-ecs --require-approval never --context useCustomDomain="true" --context domainName="$DOMAIN_NAME" --context hostedZoneName="$HOSTED_ZONE_NAME" --context hostedZoneId="$HOSTED_ZONE_ID"
                    else
                      [ "$ENABLE_COGNITO" = "true" ] && npx cdk deploy aws-idp-ai-ecs --require-approval never --context adminUserEmail="$ADMIN_USER_EMAIL" --context useCustomDomain="external" --context customDomainFull="$CUSTOM_DOMAIN_FULL" --context existingCertificateArn="$CERT_ARN" || npx cdk deploy aws-idp-ai-ecs --require-approval never --context useCustomDomain="external" --context customDomainFull="$CUSTOM_DOMAIN_FULL" --context existingCertificateArn="$CERT_ARN"
                    fi
                  else
                    [ "$ENABLE_COGNITO" = "true" ] && npx cdk deploy aws-idp-ai-ecs --require-approval never --context adminUserEmail="$ADMIN_USER_EMAIL" --context existingCertificateArn="$CERT_ARN" || npx cdk deploy aws-idp-ai-ecs --require-approval never
                  fi
                - npx cdk deploy aws-idp-ai-user-management --require-approval never
                - aws ecs update-service --cluster aws-idp-cluster-${STAGE} --service aws-idp-frontend-${STAGE} --force-new-deployment 2>/dev/null || true
                - aws ecs update-service --cluster aws-idp-cluster-${STAGE} --service aws-idp-backend-${STAGE} --force-new-deployment 2>/dev/null || true
                - |
                  if [ "$USE_CUSTOM_DOMAIN" = "true" ] && [ "$ENABLE_COGNITO" = "true" ]; then
                    USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-cognito --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
                    CLIENT_ID=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-cognito --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)
                    ALB_DNS=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-ecs --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDnsName`].OutputValue' --output text)
                    [ "$USE_ROUTE53" = "true" ] && CUSTOM_URL="https://${DOMAIN_NAME}.${HOSTED_ZONE_NAME}" || CUSTOM_URL="https://${CUSTOM_DOMAIN_FULL}"
                    aws cognito-idp update-user-pool-client --user-pool-id "$USER_POOL_ID" --client-id "$CLIENT_ID" --callback-urls "https://${ALB_DNS}" "https://${ALB_DNS}/oauth2/idpresponse" "${CUSTOM_URL}" "${CUSTOM_URL}/oauth2/idpresponse" --logout-urls "https://${ALB_DNS}" "https://${ALB_DNS}/logged-out" "${CUSTOM_URL}" "${CUSTOM_URL}/logged-out" --allowed-o-auth-flows "code" --allowed-o-auth-scopes "email" "openid" "profile" --allowed-o-auth-flows-user-pool-client --supported-identity-providers "COGNITO" >/dev/null 2>&1
                  fi
                - |
                  ALB_URL=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-ecs --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDnsName`].OutputValue' --output text)
                  if [ "$USE_CUSTOM_DOMAIN" = "true" ]; then
                    [ "$USE_ROUTE53" = "true" ] && FRONTEND_URL="https://${DOMAIN_NAME}.${HOSTED_ZONE_NAME}" || FRONTEND_URL="https://${CUSTOM_DOMAIN_FULL}"
                  else
                    FRONTEND_URL="https://${ALB_URL}"
                  fi
                  echo "FrontendURL = $FRONTEND_URL"
                  if [ "$ENABLE_COGNITO" = "true" ]; then
                    TEMP_PASSWORD=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-cognito --query 'Stacks[0].Outputs[?OutputKey==`TemporaryPassword`].OutputValue' --output text)
                    ADMIN_USERNAME=$(aws cloudformation describe-stacks --stack-name aws-idp-ai-cognito --query 'Stacks[0].Outputs[?OutputKey==`AdminUsername`].OutputValue' --output text)
                    echo "AdminUsername = $ADMIN_USERNAME"
                    echo "TemporaryPassword = $TEMP_PASSWORD"
                  fi
      TimeoutInMinutes: 60

Outputs:
  ProjectName:
    Value: !Ref CodeBuildProject
    Description: CodeBuild project name